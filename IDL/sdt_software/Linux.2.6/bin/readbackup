#!/usr/bin/ksh
#
# @(#)
#
# Read index files of a FAST data archive tape, stopping after each
# index file to give the user an opportunity to select a file to be
# extracted from the following archive to the current directory.
# First checks for a FAST label.
#

. /disks/fast/software/config/archive_config

if [[ $# != 0 ]]
then
	echo "From a FINET machine"
	echo "Usage: $0" 
	exit 1
fi

# function to rewind the tape and quit with error message on error
# Usage:rewind_tape progname sequence_count return_code
rewind_tape() {
rsh $DANETHOST mt -f ${TAPE} rewind
if [ $? -ne 0 ]
then
	echo "$1: Tape rewind ($2) failed"
	if [ $3 -ne 0 ]
	then
		exit $3
	fi
fi
}

# Start at the beginning
#if [[ $1 != "" ]]
#then
#	TAPE=$1
#fi
rewind_tape $0 1 1

# Look for the label file and quit if not found
tapeLabel=`rsh $DANETHOST dd if=${TAPE} bs=${RECSIZE} cbs=${RECSIZE} conv=unblock 2> /dev/null`
if [ $? -eq 0 -a \
	"--${tapeLabel}--" != "----"  -a \
	"`echo ${tapeLabel} | awk -F":" '{print $1}'`" = 'FAST LABEL' ]
then
	echo ""
	echo "The tape has the following FAST label:"
	echo ${tapeLabel}
	echo ""
else
	echo ""
	echo "The tape has no recognizable FAST label."
	rewind_tape $0 2 1
	exit 1
fi

# Read and report the index files, stopping after each for the user
# to select a file for extract. When selected, the file is extracted
# into the current directory.
while ( true )
do
	rsh $DANETHOST dd if=${TAPE} of=/tmp/rbindex$$ bs=${RECSIZE} cbs=${RECSIZE} conv=unblock 2> /dev/null
	rsh $DANETHOST cat /tmp/rbindex$$ > /tmp/rbindex$$
	if [ $? -ne 0  -o ! -s /tmp/rbindex$$ ]
	then
		rm -f /tmp/rbindex$$
		break
	fi

	more /tmp/rbindex$$
	echo ""
	PASS=$(sed -n '/Pass/p' /tmp/rbindex$$ | awk '{print $3}') 
	rm -f /tmp/rbindex$$

	echo "Do you want a file from this group? (y/n/q) [n] \c"
	read resp
        if [[ ${resp} = "Y" || ${resp} = "y" ]]
        then
		echo "Enter filename (or ALL for the entire archive): \c"
		read resp
		if [[ $resp = "ALL" ]]
		then
			rsh $DANETHOST $DANETBIN/rat  $TAPE $PASS
		else
			rsh $DANETHOST $DANETBIN/rat  ${TAPE} $PASS/${resp}
		fi
		print -n "Would you like any other files? (y/n):"
		read resp
		if [[ $resp != "y" ]]
		then
                	break
		else
			rsh $DANETHOST mt -f $TAPE nbsf 2
		fi
        elif [[ $resp = "q" || $resp = "Q" ]] 
	then
		rewind_tape $0 6 1
                exit
	else
		rsh $DANETHOST mt -f ${TAPE} fsf 1
		if [ $? -ne 0 ]
		then
			echo "Inconsistent number of files on tape"
			echo ""
			rm -f /tmp/rbindex$$
			break
		fi
	fi
done

# And return to the beginning
rewind_tape $0 6 1

echo "Do you want to run premaster and cutcd? (y/n) \c"
read resp
if [[ $resp = "y" ]]
then
	rsh $DANETHOST $DANETBIN/premaster $PASS rb$$ >> $LOGFILE 2>&1
        rsh $DANETHOST $DANETBIN/cutcd rb$$ >> $LOGFILE 2>&1
fi

