#! /usr/bin/sh
#
# @(#)sclabel	1.3 06/04/96 UCB SSL
#
# Writes an I&T label to the beginning of a tape. First looks for
# an existing FAST label or any data, and gives user opportunity
# to quit.
#
# Label is one 80 byte record at the beginning of the tape with the
# following format:
#
# FAST LABEL: SEC BACKUP xxxx -- LABEL WRITTEN DDD MMM dd hh:mm:ss GMT yyyy
#

if [ $# -gt 2 -o $# -eq 0 ]
then
	echo "Usage: $0 tapenumber [tape-device]"
	exit 1
fi

TAPE=/dev/rmt/0cn
RECSIZE=80
PATH=/usr/bin

# Check for a command line argument.  If it exists, use it as the tape device

if [ $# -eq 2 ]
then
	TAPE=$2
fi

if [ ! -h $TAPE ]
then
	echo "$0: $TAPE: device not found on this system"
	exit 1
fi

# function to rewind the tape and quit with error message on error
# Usage:rewind_tape progname sequence_count return_code
rewind_tape() {
mt -f ${TAPE} rewind
if [ $? -ne 0 ]
then
	echo "$1: Tape rewind ($2) failed"
	if [ $3 -ne 0 ]
	then
		exit $3
	fi
fi
}

# Now lets start at the beginning
rewind_tape $0 1 1

# See if there is anything currently on the tape
tapeLabel=`dd if=${TAPE} bs=${RECSIZE} cbs=${RECSIZE} conv=unblock 2> /dev/null`
if [ $? -eq 0 -a "--${tapeLabel}--" != "----" ]
then
	echo ""
	# If so, see if it has a FAST label
	if [ "`echo ${tapeLabel} | awk -F":" '{print $1}'`" = 'FAST LABEL' ]
	then
		echo "The tape has the following FAST label:"
		echo ${tapeLabel}
	else
		echo "The tape has data."
	fi
	echo ""
	echo "Overwrite (all data on tape will be lost)? (y/n) [n] \c"
	read resp
	if [ "x${resp}" != "xY" -a "x${resp}" != "xy" ]
	then
		rewind_tape $0 3 1
		exit 0
	fi
fi

# Now go back to the beginning again
rewind_tape $0 2 1

# Build a tape label
tapeLabel="FAST LABEL: SEC BACKUP $1 -- LABEL WRITTEN `date -u`"

# Write the label to the tape
echo ${tapeLabel} | \
	(dd of=${TAPE} bs=${RECSIZE} cbs=${RECSIZE} conv=block 2> /dev/null)
if [ $? -ne 0 ]
then
	echo "$0: Writing of label failed"
	exit 1
fi

# And return to where we started
rewind_tape $0 4 1

exit 0
