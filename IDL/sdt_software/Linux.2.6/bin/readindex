#! /usr/bin/sh
#
# @(#)readindex	1.3 04 Jun 1996 UCB SSL
#
# Reads and reports the index files of a FASTdata archive tape. Also
# checks for a FAST label and reports the number of KB already on the
# tape.
#

if [ $# -gt 1 ]
then
	echo "Usage: $0 [tape-device]"
	exit 1
fi

TAPE=/dev/rmt/0cn
ITNDXFILE=/tmp/itndx.$$
RECSIZE=80

# Check for a command line argument.  If it exists, use it as the tape device

if [ $# -eq 1 ]
then
	TAPE=$1
fi

if [ ! -h $TAPE ]
then
	echo "$0: $TAPE: device not found on this system"
	exit 1
fi

# function to rewind the tape and quit with error message on error
# Usage:rewind_tape progname sequence_count return_code
rewind_tape() {
mt -f ${TAPE} rewind
if [ $? -ne 0 ]
then
	echo "$1: Tape rewind ($2) failed"
	if [ $3 -ne 0 ]
	then
		exit $3
	fi
fi
}

# Start at the beginning
rewind_tape $0 1 1

# Look for the FAST label. Report if found and quit if not.
tapeLabel=`dd if=${TAPE} bs=${RECSIZE} cbs=${RECSIZE} conv=unblock 2> /dev/null`
if [ $? -eq 0 -a \
	"--${tapeLabel}--" != "----"  -a \
	"`echo ${tapeLabel} | awk -F":" '{print $1}'`" = 'FAST LABEL' ]
then
	echo ""
	echo "The tape has the following FAST label:"
	echo ${tapeLabel}
	echo ""
else
	echo ""
	echo "The tape has no recognizable FAST label."
	rewind_tape $0 2 1
	exit 1
fi

# Read and report the index files. Count Kbytes on tape.
kBytesOnTape=0

while [ true ]
do
	dd if=${TAPE} of=${ITNDXFILE} bs=${RECSIZE} cbs=${RECSIZE} conv=unblock 2> /dev/null
	ddstatus=$?
	sleep 1
	if [ $ddstatus -ne 0  -o ! -s ${ITNDXFILE} ]
	then
		if [ $ddstatus -ne 0 ]
		then
			echo "$1: dd error"
		fi
		
		rm -f ${ITNDXFILE}
		break
	fi

	mt -f ${TAPE} fsf 1
	mtstatus=$?
	if [ $mtstatus -ne 0 ]
	then
		echo "Inconsistent number of files on tape"
		echo ""
		rm -f ${ITNDXFILE}
		break
	fi

	byteCnt=`awk '{byteVal = $1} END {print byteVal}' ${ITNDXFILE}`
	kBytesOnTape=`expr ${kBytesOnTape} + ${byteCnt} / 1024`

	cat ${ITNDXFILE}
	echo ""
	rm -f ${ITNDXFILE}
done

# Report bytes on tape
echo "The tape has `expr ${kBytesOnTape}` KB."

# Start over again
rewind_tape $0 6 1

exit 0
